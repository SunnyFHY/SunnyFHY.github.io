<!DOCTYPE html>
<html lang="null">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <meta name="keywords" content="符涵月">
  <meta name="description" content="南邮本科生">
  
  <title>SunnyFHY</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/materialize.min.css">
    
      <link rel="stylesheet" href="/css/main.min.css">
    
  
  <style type="text/css">
      html{
          font-family: sans-serif;
          font-weight: 300;
      }
      @font-face {
          font-family: 'Material Icons';
          font-style: normal;
          font-weight: 400;
          src: url(/fonts/MaterialIcons-Regular.eot);
          src: url(/fonts/MaterialIcons-Regular.woff2) format('woff2'),
          url(/fonts/MaterialIcons-Regular.woff) format('woff'),
          url(/fonts/MaterialIcons-Regular.ttf) format('truetype')
      }
  </style>
<link rel="shortcut icon" href="/source/favicon.ico">
</head>
<body>
<div id="menu-box"><a href="javascript:void(0)" id="menu" data-activates="slide-out" class="button-collapse menu" ><span class="nav-btn"></span></a></div>
<div id="menu-outer">
  <div id="menu-inner">
      <ul id="slide-out" class="side-nav" >
    <div class="nav-header"  style="background-image: url(/images/Coconutree_Moon.jpg);background-color:#26A69A">
    <div class="header-box"><img src="/images/Spongebob.jpg" ondragstart="return false;"></div>
    <p>SunnyFHY</p>
    <div class="nav-link">
        
        
        <a  href="https://github.com/SunnyFHY" target="_blank"><div class="link-box github"></div></a>
        
        
        
        
    </div>
    <div class="nav-search">
        <form id="search-form"> <!-- 搜索框相关 -->
            <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索..." class="search form-control" autocomplete="off" autocorrect="off"/>
            <div class="nav-search-img"><i class="material-icons">search</i></div>
        </form>
        <div id="local-search-result"></div> <!-- 搜索结果区 -->
        <p class='no-result'>无搜索结果</p>
    </div>
</div>
    <!--Homepage-->

<li class="nav-list">
    <a href="/" target="_self">
        <div class="nav-ico"><i class="material-icons">home</i> </div><p>主页</p>
    </a>
</li>

<!--archives-->

<li class="nav-list dropdown-btn">
    <a  class=""  target="_self">
        <div class="nav-ico"><i class="material-icons">assignment</i></div><p>归档</p><div class="dropdown-ico"><i class="material-icons">arrow_drop_down</i></div>
    </a>
</li>

<ul class="dropdown-menu dropdown" >
    <li class="nav-dropdown-list">
        <a class="archive-link" href="/archives/2019/02/">February 2019<span class="archive-count">1</span></a></li><li class="nav-dropdown-list"><a class="archive-link" href="/archives/2018/12/">December 2018<span class="archive-count">2</span></a></li><li class="nav-dropdown-list"><a class="archive-link" href="/archives/2018/10/">October 2018<span class="archive-count">3</span></a>
    </li>
</ul>
<!--categories-->

<li class="nav-list dropdown-btn">
    <a   class=""  target="_self">
        <div class="nav-ico"><i class="material-icons">dashboard</i></div><p>分类</p><div class="dropdown-ico"><i class="material-icons">arrow_drop_down</i></div>
    </a>
</li>

<ul class="dropdown-menu dropdown" >
    <li class="nav-dropdown-list">
        <a class="category-link" href="/categories/VivadoHLS/">VivadoHLS<span class="category-count">2</span></a></li><li class="nav-dropdown-list"><a class="category-link" href="/categories/四旋翼/">四旋翼<span class="category-count">1</span></a></li><li class="nav-dropdown-list"><a class="category-link" href="/categories/操作系统/">操作系统<span class="category-count">2</span></a></li><li class="nav-dropdown-list"><a class="category-link" href="/categories/树莓派/">树莓派<span class="category-count">1</span></a>
    </li>
</ul>
<!--tags-->

<!--photo-->

<!--friends-->

<!--about-->

<li class="nav-list">
    <a href="/about" target="_self">
        <div class="nav-ico"><i class="material-icons">copyright</i> </div><p>关于</p>
    </a>
</li>


</ul>

  </div>
</div>

<div id="content-outer">
  <div id="content-inner">
    
<article id="post">
  <div class="post-page-title"  style="background-color:#26A69A;background-image:url(/images/random/vateral-14.png)" >
  <h2>vivadoHLS（二）</h2>
    
  <p>作者:SunnyFHY &nbsp&nbsp 发布于:<time datetime="2018-12-09T15:29:17.000Z">
          2018-12-09
    </time>
  </p>
    
  </div>
  <div class="post-page-content">
  <h1 id="HLS学习"><a href="#HLS学习" class="headerlink" title="HLS学习"></a>HLS学习</h1><p><img src="/2018/12/09/hls2/1539354344835.png" alt="1539354344835"></p>
<p>上图是HLS完整工作过程，其中Contraints/Directives是在软件里设置的，可以对同一份C语言转电路设计的时候实现全并行或全串行设计等设置。HLS最后生成IP核，可以在Vivado里打开。</p>
<h2 id="部分HLS-C语言约束（不完全版）"><a href="#部分HLS-C语言约束（不完全版）" class="headerlink" title="部分HLS C语言约束（不完全版）"></a>部分HLS C语言约束（不完全版）</h2><p><strong>HLS C语言体系中不支持的元素</strong></p>
<p>虽然在HLS中C语言的大部分特性被广泛支持，但是仍存在一部分不可综合的C语言代码。这些代码在向底层的设计转化过程中会产生错误。接下来将讨论HLS中C语言代码设计时的可综合性和在器件中的可执行性。</p>
<p>可综合的C语言代码具有以下特性：</p>
<p>1、C语言程序的组成部分全部为函数。</p>
<p>2、对操作系统层面有需求的函数不能被综合。</p>
<p>3、C语言构造必须是定长或者有边界的。</p>
<p>4.C语言构造的设计面对FPGA硬件执行层面是明确的。</p>
<p><strong>System Calls 系统调用</strong></p>
<p>系统调用的函数不能被综合的原因在于它们往往会在C语言程序执行的过程中执行基于操作系统层面的任务,而在FPGA底层不存在操作系统。</p>
<p>Vivado HLS在综合的时候自动忽视掉对算法不产生影响的常用系统调用函数，这些函数不需要在综合之前被移除，例如：</p>
<p>• abort()  • atexit()  • exit()  • fprintf()  • printf() </p>
<p>• perror()  • putchar()  • puts()  • time()  • sleep()  • getc()</p>
<p>不过通常来说，不可综合的代码理应在综合前被移除。可以利用如下的宏，确保不可综合的C代码不会被vivado HLS综合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">macro:  __SYNTHESIS__</div></pre></td></tr></table></figure>
<p>具体例子，参见如下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hier_func4.h"</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sumsub_func</span><span class="params">(<span class="keyword">din_t</span> *in1, <span class="keyword">din_t</span> *in2, <span class="keyword">dint_t</span> *outSum, <span class="keyword">dint_t</span> *outSub)</span></span></div><div class="line">&#123;</div><div class="line">*outSum = *in1 + *in2;</div><div class="line">*outSub = *in1 - *in2;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">shift_func</span><span class="params">(<span class="keyword">dint_t</span> *in1, <span class="keyword">dint_t</span> *in2, <span class="keyword">dout_t</span> *outA, <span class="keyword">dout_t</span> *outB)</span></span></div><div class="line">&#123;</div><div class="line">*outA = *in1 &gt;&gt; <span class="number">1</span>;</div><div class="line">*outB = *in2 &gt;&gt; <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hier_func4</span><span class="params">(<span class="keyword">din_t</span> A, <span class="keyword">din_t</span> B, <span class="keyword">dout_t</span> *C, <span class="keyword">dout_t</span> *D)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">dint_t</span> apb, amb;</div><div class="line">sumsub_func(&amp;A,&amp;B,&amp;apb,&amp;amb);</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __SYNTHESIS__</span></div><div class="line">FILE *fp1;<span class="comment">// The following code is ignored for synthesis</span></div><div class="line"><span class="keyword">char</span> filename[<span class="number">255</span>];</div><div class="line"><span class="built_in">sprintf</span>(filename,Out_apb_%<span class="number">03</span>d.dat,apb);</div><div class="line">fp1=fopen(filename,w);</div><div class="line"><span class="built_in">fprintf</span>(fp1, %d \n, apb);</div><div class="line">fclose(fp1);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">shift_func(&amp;apb,&amp;amb,C,D);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>值得注意的是</strong>：上述的宏仅作用于被综合的C代码，不适用于 test bench。因为这个宏不遵循C仿真和C/RTL仿真的规则。</p>
<p><strong>Dynamic Memory Usage 动态内存使用</strong></p>
<p>调用内存分配管理函数都是基于系统层面的，例如malloc(),alloc(),和free()函数都是在程序运行过程中利用操作系统内存的资源去创建和释放存储空间。为了可被综合，在硬件执行的设计上必须脱离操作系统支持，并且明确资源需求。</p>
<p>内存分配的系统调用代码必须在综合之前被移除。因为动态内存操作在设计流程中属于特有功能点，它们必须被转化为等价的有边界构造。接下来的例程将会展示如何设计一段可被综合的malloc()代码，顺带重点提示一下两点十分有用的代码设计技巧：</p>
<p>1.例程设计没有用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__SYNTHESIS__    这个宏</div></pre></td></tr></table></figure>
<p>用户自定义宏NO_SYNTH用于选择可综合和不可综合代码版本。这样子就可以用同样的代码进行C仿真和Vivado HLS综合。</p>
<p>2.原本设计中用于malloc()函数的指针不用修改就可以指向有定长的数据结构。</p>
<p>有定长的数据结构可以被创建，现存的指针用于指向新的数据结构即可。这个技巧可以避免人为地对代码进行大篇幅改动。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"malloc_removed.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="comment">//#define NO_SYNTH</span></div><div class="line"><span class="keyword">dout_t</span> malloc_removed(<span class="keyword">din_t</span> din[N], <span class="keyword">dsel_t</span> width) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NO_SYNTH</span></div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> *out_accum = <span class="built_in">malloc</span> (<span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>));</div><div class="line"><span class="keyword">int</span>* array_local = <span class="built_in">malloc</span> (<span class="number">64</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> _out_accum;</div><div class="line"><span class="keyword">long</span> <span class="keyword">long</span> *out_accum = &amp;_out_accum;</div><div class="line"><span class="keyword">int</span> _array_local[<span class="number">64</span>];</div><div class="line"><span class="keyword">int</span>* array_local = &amp;_array_local[<span class="number">0</span>];</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="keyword">int</span> i,j;</div><div class="line">LOOP_SHIFT:<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;N<span class="number">-1</span>; i++) &#123;</div><div class="line"><span class="keyword">if</span> (i&lt;width)</div><div class="line">*(array_local+i)=din[i];</div><div class="line"><span class="keyword">else</span></div><div class="line">*(array_local+i)=din[i]&gt;&gt;<span class="number">2</span>;</div><div class="line">&#125;</div><div class="line">*out_accum=<span class="number">0</span>;</div><div class="line">LOOP_ACCUM:<span class="keyword">for</span> (j=<span class="number">0</span>;j&lt;N<span class="number">-1</span>; j++) &#123;</div><div class="line">*out_accum += *(array_local+j);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> *out_accum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Pointer Limitations 指针限制</strong></p>
<p><strong><em>General Pointer Casting常规指针类型转换</em></strong>  </p>
<p>Vivado HLS 不支持常规意义上的指针类型转化。例如，当一个结构体被初始化，且其中的成员变量被定义为有符号数据类型时，结构体指针不能被转换为无符号数据类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> &#123;</div><div class="line"><span class="keyword">short</span> first;</div><div class="line"><span class="keyword">short</span> second;</div><div class="line">&#125; pair;</div><div class="line"><span class="comment">// Not supported for synthesis</span></div><div class="line">*(<span class="keyword">unsigned</span>*)pair = <span class="number">-1</span>U;</div></pre></td></tr></table></figure>
<p>在这种情况下，结构体指针只能用原定义数据类型。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> &#123;</div><div class="line"><span class="keyword">short</span> first;</div><div class="line"><span class="keyword">short</span> second;</div><div class="line">&#125; pair;</div><div class="line"><span class="comment">// Assigned value</span></div><div class="line">pair.first = <span class="number">-1</span>U;</div><div class="line">pair.second = <span class="number">-1</span>U;</div></pre></td></tr></table></figure>
<p>指针数组也能被综合，见下面例程：此例程中的指针数组用于存储一个全局数组第二维度的起始地址。指针数组的指针只能指向标量或标量数组，而不能指向其他指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pointer_array.h"</span></span></div><div class="line"><span class="keyword">data_t</span> A[N][<span class="number">10</span>];</div><div class="line"><span class="keyword">data_t</span> pointer_array(<span class="keyword">data_t</span> B[N*<span class="number">10</span>]) &#123;</div><div class="line"><span class="keyword">data_t</span> i,j;</div><div class="line"><span class="keyword">data_t</span> sum1;</div><div class="line"><span class="comment">// Array of pointers</span></div><div class="line"><span class="keyword">data_t</span>* PtrA[N];</div><div class="line"><span class="comment">// Store global array locations in temp pointer array</span></div><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; ++i)</div><div class="line">PtrA[i] = &amp;(A[i][<span class="number">0</span>]);</div><div class="line"><span class="comment">// Copy input array using pointers</span></div><div class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;N; ++i)</div><div class="line"><span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">10</span>; ++j)</div><div class="line">*(PtrA[i]+j) = B[i*<span class="number">10</span> + j];</div><div class="line"><span class="comment">// Sum input array</span></div><div class="line">sum1 = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;N; ++i)</div><div class="line"><span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">10</span>; ++j)</div><div class="line">sum1 += *(PtrA[i] + j);</div><div class="line"><span class="keyword">return</span> sum1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>Recursive Functions递归函数</strong></p>
<p>无穷递归的递归函数不可被综合：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">foo</span> <span class="params">(<span class="keyword">unsigned</span> n)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> (n == <span class="number">0</span> || n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"><span class="keyword">return</span> (foo(n<span class="number">-2</span>) + foo(n<span class="number">-1</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Vivado HLS不支持对数值进行无尽调用的尾递归函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">foo</span> <span class="params">(<span class="keyword">unsigned</span> m, <span class="keyword">unsigned</span> n)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">if</span> (m == <span class="number">0</span>) <span class="keyword">return</span> n;</div><div class="line"><span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> m;</div><div class="line"><span class="keyword">return</span> foo(n, m%n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>C Test Bench C测试台</strong></p>
<p>任何模块综合的第一步都是验证C函数的功能是否正确。这个步骤由测试台完成。设计一个好的测试台代码能极大程度上增加你的效率。</p>
<p>C函数执行比RTL仿真快。在综合之前使用C语言去开发和验证算法比开发RTL级代码更有效率。</p>
<p>Vivado HLS 重复利用C测试台去验证RTL设计。在使用Vivado HLS时不需要设计任何RTL测试台代码。如果测试台验证过了顶层函数的结果，RTL仿真也会同时通过验证。  </p>
<p><strong>注意：</strong>为测试台代码提供参数的时候，选择 Project &gt; Project Settings,点击Simulation ,使用Input Arguments 选项。Test Bench文件不支持交互式用户输入。Vivado HLS图形界面没有命令行控制台，也不支持在测试台程序执行的过程中接收用户输入。</p>
<p>Xilinx建议在综合的时候从测试台文件中将顶层函数分离出来，可以使用头文件。接下来的例程中hier_func函数对两个子函数进行调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hier_func.h"</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sumsub_func</span><span class="params">(<span class="keyword">din_t</span> *in1, <span class="keyword">din_t</span> *in2, <span class="keyword">dint_t</span> *outSum, <span class="keyword">dint_t</span> *outSub)</span></span></div><div class="line">&#123;</div><div class="line">*outSum = *in1 + *in2;</div><div class="line">*outSub = *in1 - *in2;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">shift_func</span><span class="params">(<span class="keyword">dint_t</span> *in1, <span class="keyword">dint_t</span> *in2, <span class="keyword">dout_t</span> *outA, <span class="keyword">dout_t</span> *outB)</span></span></div><div class="line">&#123;</div><div class="line">*outA = *in1 &gt;&gt; <span class="number">1</span>;</div><div class="line">*outB = *in2 &gt;&gt; <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hier_func</span><span class="params">(<span class="keyword">din_t</span> A, <span class="keyword">din_t</span> B, <span class="keyword">dout_t</span> *C, <span class="keyword">dout_t</span> *D)</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">dint_t</span> apb, amb;</div><div class="line">sumsub_func(&amp;A,&amp;B,&amp;apb,&amp;amb);</div><div class="line">shift_func(&amp;apb,&amp;amb,C,D);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>顶层函数可以包含多个子函数。只能有一个顶层函数被综合。为了综合多个函数，可以把这些函数都放在一个顶层函数里调用。</p>
<p>为了综合hier_func这个函数：</p>
<p>1.添加上述例程到Vivado HLS工程里作为设计文件。</p>
<p>2.声明hier_func为顶层函数。</p>
<p>综合之后：</p>
<p>• 传递给顶层函数的参数被综合为RTL引脚。</p>
<p>• 顶层函数里包含的子函数被综合成分层次的模块。</p>
<p>下述头文件为上述例程的头文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _HIER_FUNC_H_</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _HIER_FUNC_H_</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_TRANS 40</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">din_t</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">dint_t</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">dout_t</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hier_func</span><span class="params">(<span class="keyword">din_t</span> A, <span class="keyword">din_t</span> B, <span class="keyword">dout_t</span> *C, <span class="keyword">dout_t</span> *D)</span></span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>这个头文件包含了很多原设计文件里面没有的定义（比如NUM_TRANS）。这些定义是用于测试台文件，测试台文件同样包含这个头文件。</p>
<p>下述代码是这个工程里的测试台文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hier_func.h"</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="comment">// Data storage</span></div><div class="line"><span class="keyword">int</span> a[NUM_TRANS], b[NUM_TRANS];</div><div class="line"><span class="keyword">int</span> c_expected[NUM_TRANS], d_expected[NUM_TRANS];</div><div class="line"><span class="keyword">int</span> c[NUM_TRANS], d[NUM_TRANS];</div><div class="line"><span class="comment">//Function data (to/from function)</span></div><div class="line"><span class="keyword">int</span> a_actual, b_actual;</div><div class="line"><span class="keyword">int</span> c_actual, d_actual;</div><div class="line"><span class="comment">// Misc</span></div><div class="line"><span class="keyword">int</span> retval=<span class="number">0</span>, i, i_trans, tmp;</div><div class="line">FILE *fp;</div><div class="line"><span class="comment">// Load input data from files</span></div><div class="line">fp=fopen(tb_data/inA.dat,r);</div><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;NUM_TRANS; i++)&#123;</div><div class="line"><span class="built_in">fscanf</span>(fp, %d, &amp;tmp);</div><div class="line">a[i] = tmp;</div><div class="line">&#125;</div><div class="line">fclose(fp);</div><div class="line">fp=fopen(tb_data/inB.dat,r);</div><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;NUM_TRANS; i++)&#123;</div><div class="line"><span class="built_in">fscanf</span>(fp, %d, &amp;tmp);</div><div class="line">b[i] = tmp;</div><div class="line">&#125;</div><div class="line">fclose(fp);</div><div class="line"><span class="comment">// Execute the function multiple times (multiple transactions)</span></div><div class="line"><span class="keyword">for</span>(i_trans=<span class="number">0</span>; i_trans&lt;NUM_TRANS<span class="number">-1</span>; i_trans++)&#123;</div><div class="line"><span class="comment">//Apply next data values</span></div><div class="line">a_actual = a[i_trans];</div><div class="line">b_actual = b[i_trans];</div><div class="line">hier_func(a_actual, b_actual, &amp;c_actual, &amp;d_actual);</div><div class="line"><span class="comment">//Store outputs</span></div><div class="line">c[i_trans] = c_actual;</div><div class="line">d[i_trans] = d_actual;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Load expected output data from files</span></div><div class="line">fp=fopen(tb_data/outC.golden.dat,r);</div><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;NUM_TRANS; i++)&#123;</div><div class="line"><span class="built_in">fscanf</span>(fp, %d, &amp;tmp);</div><div class="line">c_expected[i] = tmp;</div><div class="line">&#125;</div><div class="line">fclose(fp);</div><div class="line">fp=fopen(tb_data/outD.golden.dat,r);</div><div class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;NUM_TRANS; i++)&#123;</div><div class="line"><span class="built_in">fscanf</span>(fp, %d, &amp;tmp);</div><div class="line">d_expected[i] = tmp;</div><div class="line">&#125;</div><div class="line">fclose(fp);</div><div class="line"><span class="comment">// Check outputs against expected</span></div><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_TRANS<span class="number">-1</span>; ++i) &#123;</div><div class="line"><span class="keyword">if</span>(c[i] != c_expected[i])&#123;</div><div class="line">retval = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>(d[i] != d_expected[i])&#123;</div><div class="line">retval = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Print Results</span></div><div class="line"><span class="keyword">if</span>(retval == <span class="number">0</span>)&#123;</div><div class="line"><span class="built_in">printf</span>( *** *** *** *** \n);</div><div class="line"><span class="built_in">printf</span>( Results are good \n);</div><div class="line"><span class="built_in">printf</span>( *** *** *** *** \n);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="built_in">printf</span>( *** *** *** *** \n);</div><div class="line"><span class="built_in">printf</span>( Mismatch: retval=%d \n, retval);</div><div class="line"><span class="built_in">printf</span>( *** *** *** *** \n);</div><div class="line">&#125;</div><div class="line"><span class="comment">// Return 0 if outputs are correct</span></div><div class="line"><span class="keyword">return</span> retval;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="池化和卷积HLS-C语言代码"><a href="#池化和卷积HLS-C语言代码" class="headerlink" title="池化和卷积HLS C语言代码"></a>池化和卷积HLS C语言代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//池化代码main函数</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pool_core.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MODE 	0	<span class="comment">//mode: 0:MEAN, 1:MIN, 2:MAX</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_WIDTH 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_HEIGHT 6</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_CH 1</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_WIDTH 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_HEIGHT 3</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT_WIDTH (IN_WIDTH/KERNEL_WIDTH)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT_HEIGHT (IN_HEIGHT/KERNEL_HEIGHT)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	Dtype_f feature_in[IN_HEIGHT][IN_WIDTH][IN_CH];</div><div class="line">	Dtype_f feature_out[OUT_HEIGHT][OUT_WIDTH][IN_CH];</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;IN_HEIGHT;i++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;IN_WIDTH;j++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cin</span>=<span class="number">0</span>;<span class="built_in">cin</span>&lt;IN_CH;<span class="built_in">cin</span>++)</div><div class="line">				feature_in[i][j][<span class="built_in">cin</span>]=i*IN_WIDTH+j;</div><div class="line"></div><div class="line">	Pool(IN_CH,IN_HEIGHT,IN_WIDTH,</div><div class="line">			KERNEL_WIDTH,KERNEL_HEIGHT,MODE,</div><div class="line">			feature_in[<span class="number">0</span>][<span class="number">0</span>],feature_out[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">		);<span class="comment">//mode: 0:MEAN, 1:MIN, 2:MAX</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;OUT_HEIGHT;i++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;OUT_WIDTH;j++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cout</span>=<span class="number">0</span>;<span class="built_in">cout</span>&lt;IN_CH;<span class="built_in">cout</span>++)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"OUT[%d][%d][%d]=%f\n"</span>,i,j,<span class="built_in">cout</span>,feature_out[i][j][<span class="built_in">cout</span>]);</div><div class="line">			&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//池化代码池化函数</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pool_core.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> max(a,b) ((a&gt;b)?a:b)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> min(a,b) ((a&gt;b)?b:a)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Pool</span><span class="params">(ap_uint&lt;<span class="number">16</span>&gt; CHin,ap_uint&lt;<span class="number">16</span>&gt; Hin,ap_uint&lt;<span class="number">16</span>&gt; Win,</span></span></div><div class="line">		ap_uint&lt;<span class="number">8</span>&gt; Kx,ap_uint&lt;<span class="number">8</span>&gt; Ky,ap_uint&lt;<span class="number">2</span>&gt; mode,</div><div class="line">		Dtype_f feature_in[],Dtype_f feature_out[]</div><div class="line">	)<span class="comment">//mode: 0:MEAN, 1:MIN, 2:MAX</span></div><div class="line">&#123;</div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=feature_out offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=feature_in offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Win</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Kx</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Hin</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=mode</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Ky</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=CHin</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=return</span></div><div class="line">	ap_uint&lt;<span class="number">16</span>&gt; Hout,Wout;</div><div class="line">	Wout=Win/Kx;</div><div class="line">	Hout=Hin/Ky;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>;c&lt;CHin;c++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Hout;i++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;Wout;j++)</div><div class="line">			&#123;</div><div class="line">				Dtype_f sum;</div><div class="line">				<span class="keyword">if</span>(mode==<span class="number">0</span>)</div><div class="line">					sum=<span class="number">0</span>;</div><div class="line">				<span class="keyword">else</span></div><div class="line">					<span class="keyword">if</span>(mode==<span class="number">1</span>)</div><div class="line">						sum=<span class="number">99999999999999999</span>;</div><div class="line">					<span class="keyword">else</span></div><div class="line">						sum=<span class="number">-99999999999999999</span>;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> ii=<span class="number">0</span>;ii&lt;Ky;ii++)</div><div class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> jj=<span class="number">0</span>;jj&lt;Kx;jj++)</div><div class="line">					&#123;</div><div class="line">						ap_int&lt;<span class="number">16</span>&gt; h=i*Ky+ii;</div><div class="line">						ap_int&lt;<span class="number">16</span>&gt; w=j*Kx+jj;</div><div class="line">						<span class="keyword">switch</span>(mode)</div><div class="line">						&#123;</div><div class="line">							<span class="keyword">case</span> <span class="number">0</span>:&#123;sum+=feature_in[h*CHin*Win+w*CHin+c];<span class="keyword">break</span>;&#125;</div><div class="line">							<span class="keyword">case</span> <span class="number">1</span>:&#123;sum=min(sum,feature_in[h*CHin*Win+w*CHin+c]);<span class="keyword">break</span>;&#125;</div><div class="line">							<span class="keyword">case</span> <span class="number">2</span>:&#123;sum=max(sum,feature_in[h*CHin*Win+w*CHin+c]);<span class="keyword">break</span>;&#125;</div><div class="line">							<span class="keyword">default</span>:<span class="keyword">break</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				<span class="keyword">if</span>(mode==<span class="number">0</span>)</div><div class="line">					sum=sum/(Kx*Ky);</div><div class="line">				feature_out[i*Wout*CHin+j*CHin+c]=sum;</div><div class="line">			&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//卷积代码main函数</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdio.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"conv_core.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_WIDTH 10</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_HEIGHT 10</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> IN_CH 16</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_WIDTH 5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_HEIGHT 5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> X_STRIDE 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> Y_STRIDE 1</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RELU_EN  0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MODE     0          <span class="comment">//0:VALID, 1:SAME</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> X_PADDING (MODE?(KERNEL_WIDTH-1)/2:0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> Y_PADDING (MODE?(KERNEL_HEIGHT-1)/2:0)</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT_CH 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT_WIDTH ((IN_WIDTH+2*X_PADDING-KERNEL_WIDTH)/X_STRIDE+1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OUT_HEIGHT ((IN_HEIGHT+2*Y_PADDING-KERNEL_HEIGHT)/Y_STRIDE+1)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	Dtype_f feature_in[IN_HEIGHT][IN_WIDTH][IN_CH];</div><div class="line">	Dtype_w W[KERNEL_HEIGHT][KERNEL_WIDTH][IN_CH][OUT_CH];</div><div class="line">	Dtype_w bias[OUT_CH];</div><div class="line">	Dtype_f feature_out[OUT_HEIGHT][OUT_WIDTH][OUT_CH];</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;IN_HEIGHT;i++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;IN_WIDTH;j++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cin</span>=<span class="number">0</span>;<span class="built_in">cin</span>&lt;IN_CH;<span class="built_in">cin</span>++)</div><div class="line">				feature_in[i][j][<span class="built_in">cin</span>]=i*IN_WIDTH+j;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;KERNEL_HEIGHT;i++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;KERNEL_WIDTH;j++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cin</span>=<span class="number">0</span>;<span class="built_in">cin</span>&lt;IN_CH;<span class="built_in">cin</span>++)</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cout</span>=<span class="number">0</span>;<span class="built_in">cout</span>&lt;OUT_CH;<span class="built_in">cout</span>++)</div><div class="line">					W[i][j][<span class="built_in">cin</span>][<span class="built_in">cout</span>]=i*KERNEL_WIDTH+j;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cout</span>=<span class="number">0</span>;<span class="built_in">cout</span>&lt;OUT_CH;<span class="built_in">cout</span>++)</div><div class="line">		bias[<span class="built_in">cout</span>]=<span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="built_in">printf</span>(<span class="string">"1234\n"</span>);</div><div class="line"></div><div class="line">	Conv(IN_CH,IN_HEIGHT,IN_WIDTH,OUT_CH,</div><div class="line">			KERNEL_WIDTH,KERNEL_HEIGHT,X_STRIDE,Y_STRIDE,MODE,RELU_EN,</div><div class="line">			feature_in[<span class="number">0</span>][<span class="number">0</span>],W[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>],bias,feature_out[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">		);</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;OUT_HEIGHT;i++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;OUT_WIDTH;j++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cout</span>=<span class="number">0</span>;<span class="built_in">cout</span>&lt;OUT_CH;<span class="built_in">cout</span>++)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"OUT[%d][%d][%d]=%f\n"</span>,i,j,<span class="built_in">cout</span>,feature_out[i][j][<span class="built_in">cout</span>]);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//卷积代码卷积函数</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"conv_core.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//Feature: [H][W][C]</span></div><div class="line"><span class="comment">//kernel: [Ky][Kx][CHin][CHout]</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Conv</span><span class="params">(ap_uint&lt;<span class="number">16</span>&gt; CHin,ap_uint&lt;<span class="number">16</span>&gt; Hin,ap_uint&lt;<span class="number">16</span>&gt; Win,ap_uint&lt;<span class="number">16</span>&gt; CHout,</span></span></div><div class="line">		ap_uint&lt;<span class="number">8</span>&gt; Kx,ap_uint&lt;<span class="number">8</span>&gt; Ky,ap_uint&lt;<span class="number">8</span>&gt; Sx,ap_uint&lt;<span class="number">8</span>&gt; Sy,ap_uint&lt;<span class="number">1</span>&gt; mode,ap_uint&lt;<span class="number">1</span>&gt; relu_en,</div><div class="line">		Dtype_f feature_in[],Dtype_w W[],Dtype_w bias[],Dtype_f feature_out[]</div><div class="line">	)<span class="comment">//mode: 0:VALID, 1:SAME</span></div><div class="line">&#123;</div><div class="line">	<span class="comment">//#pragma HLS PIPELINE enable_flush</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=feature_out offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=bias offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=W offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE m_axi depth=4294967295 port=feature_in offset=slave</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=relu_en</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=CHout</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Sx</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Hin</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=CHin</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Kx</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=mode</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Sy</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Ky</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=Win</span></div><div class="line">	<span class="meta">#<span class="meta-keyword">pragma</span> HLS INTERFACE s_axilite port=return</span></div><div class="line"></div><div class="line">	ap_uint&lt;<span class="number">8</span>&gt; pad_x,pad_y;</div><div class="line">	<span class="keyword">if</span>(mode==<span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		pad_x=<span class="number">0</span>;pad_y=<span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		pad_x=(Kx<span class="number">-1</span>)/<span class="number">2</span>;pad_y=(Ky<span class="number">-1</span>)/<span class="number">2</span>;</div><div class="line">	&#125;</div><div class="line">	ap_uint&lt;<span class="number">16</span>&gt; Hout,Wout;</div><div class="line">	Wout=(Win+<span class="number">2</span>*pad_x-Kx)/Sx+<span class="number">1</span>;</div><div class="line">	Hout=(Hin+<span class="number">2</span>*pad_y-Ky)/Sy+<span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cout</span>=<span class="number">0</span>;<span class="built_in">cout</span>&lt;CHout;<span class="built_in">cout</span>++)</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Hout;i++)</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;Wout;j++)</div><div class="line">			&#123;</div><div class="line">				Dtype_acc sum=<span class="number">0</span>;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> ii=<span class="number">0</span>;ii&lt;Ky;ii++)</div><div class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> jj=<span class="number">0</span>;jj&lt;Kx;jj++)</div><div class="line">					&#123;</div><div class="line">						ap_int&lt;<span class="number">16</span>&gt; h=i*Sy-pad_y+ii;</div><div class="line">						ap_int&lt;<span class="number">16</span>&gt; w=j*Sx-pad_x+jj;</div><div class="line">						<span class="keyword">if</span>(h&gt;=<span class="number">0</span> &amp;&amp; w&gt;=<span class="number">0</span> &amp;&amp; h&lt;Hin &amp;&amp; w&lt;Win)</div><div class="line">						&#123;</div><div class="line">							<span class="keyword">for</span>(<span class="keyword">int</span> <span class="built_in">cin</span>=<span class="number">0</span>;<span class="built_in">cin</span>&lt;CHin;<span class="built_in">cin</span>++)</div><div class="line">							&#123;</div><div class="line">								<span class="comment">//Feature [H][W][C]</span></div><div class="line">								<span class="comment">//kernel: [Ky][Kx][CHin][CHout]</span></div><div class="line">								<span class="comment">//Dtype_mul tp=feature_in[h][w][cin]*w[ii][jj][cin][cout];</span></div><div class="line">								<span class="comment">//std::cout&lt;&lt;"h:"&lt;&lt;h&lt;&lt;",w"&lt;&lt;w&lt;&lt;",cin"&lt;&lt;cin&lt;&lt;"\n";</span></div><div class="line">								<span class="comment">//std::cout&lt;&lt;"feature_in["&lt;&lt;h*CHin*Win+w*CHin+cin&lt;&lt;"]*W["&lt;&lt;ii*Kx*CHin*CHout+jj*CHin*CHout+cin*CHout+cout&lt;&lt;"]\n";</span></div><div class="line">								Dtype_mul tp=feature_in[h*CHin*Win+w*CHin+<span class="built_in">cin</span>]*W[ii*Kx*CHin*CHout+jj*CHin*CHout+<span class="built_in">cin</span>*CHout+<span class="built_in">cout</span>];</div><div class="line">								sum+=tp;</div><div class="line">							&#125;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line"></div><div class="line">				sum+=bias[<span class="built_in">cout</span>];</div><div class="line">				<span class="keyword">if</span>(relu_en &amp; sum&lt;<span class="number">0</span>)</div><div class="line">					sum=<span class="number">0</span>;</div><div class="line">				<span class="comment">//feature_out[i][j][cout]=sum;</span></div><div class="line">				feature_out[i*Wout*CHout+j*CHout+<span class="built_in">cout</span>]=sum;</div><div class="line">			&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

  </div>
  <!--评论块-->
    

</article>
<nav class="post-nav">
  <!-- Prev Nav -->
    
  <a href="/2018/12/10/ucosiii2/" id="post_nav-newer" class="post-nav-content prev-content">
      新篇
  </a>
    


  <!-- Next Nav -->
    
  <a href="/2018/10/30/四旋翼PID调参笔记/" id="post_nav-older" class="post-nav-content next-content">
      旧篇
  </a>
    
</nav>
<div class="post-toc-btn"><i class="material-icons">format_list_numbered</i></div>
<div class="post-toc-none"><p>(无)</p></div>
<div class="post-toc-box">
    <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#HLS学习"><span class="post-toc-number">1.</span> <span class="post-toc-text">HLS学习</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#部分HLS-C语言约束（不完全版）"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">部分HLS C语言约束（不完全版）</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#池化和卷积HLS-C语言代码"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">池化和卷积HLS C语言代码</span></a></li></ol></li></ol>
</div>
<!--<div class="post-back"><i class="material-icons">arrow_back</i></div>-->
<script type="text/javascript">
    menu();
</script>
  </div>
</div>
<div id="bottom-outer">
  <div id="bottom-inner">
    <a  id="top-button" onfocus="this.blur();"><div class="up upinbody" style="background-color:#26A69A"><i class="material-icons material-up">vertical_align_top</i></div></a>


<p >Copyright ©  2017  SunnyFHY</p>
<p >Powered by <a href="https://hexo.io/" target="_blank"> Hexo </a> & Theme - <a href="https://github.com/moumao/hexo-theme-Vateral" target="_blank">Vateral</a></p>
<p style="font-size: 10px" id="footer-times" data-time="10/01/2018 00:00:00"></p>
<script>
    var beginTime=document.getElementById("footer-times").dataset.time
    function show_date_time(){
        var span=document.getElementById("footer-times")
        window.setTimeout("show_date_time()", 1000);
        BirthDay=new Date(beginTime);//初始日期
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        e_hrsold=(e_daysold-daysold)*24;
        hrsold=Math.floor(e_hrsold);
        e_minsold=(e_hrsold-hrsold)*60;
        minsold=Math.floor((e_hrsold-hrsold)*60);
        seconds=Math.floor((e_minsold-minsold)*60);
        span.innerHTML="本站已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
    }
    show_date_time();
</script>

  </div>
</div>

<!--影集界面需要的资源-->



<!-- scripts list from theme config.yml -->

<script src="/js/jquery-3.1.1.min.js"></script>

<script src="/js/materialize.min.js"></script>

<script src="/js/main.min.js"></script>


<script>
    NProgress.start();
    NProgress.done();
    lazy();
    links();
    window.onpopstate = menu();
    //pjax操作
    $(document).pjax('a:not(.nopjax)', '#content-inner', {fragment:'#content-inner', timeout:8000});
    $(document).on('pjax:start', NProgress.start).on('pjax:end', NProgress.done)
        .on('pjax:end', () => {
            dowmdiv();
            lazy();
            toc();
            links();
            menu();
        });
</script>

</body>
</html>
